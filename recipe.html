<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>今日食谱 - 随机美食推荐</title>
    <link rel="stylesheet" href="style.css"> <!-- 共用网站基础样式 -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css">
    <style>
        .recipe-container {
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
        }
        .recipe-image {
            max-width: 100%;
            height: auto;
            border-radius: 8px;
            margin-bottom: 20px;
        }
        .loading {
            display: flex;
            justify-content: center;
            align-items: center;
            height: 200px;
        }
        .step {
            margin-bottom: 15px;
            padding: 10px;
            background-color: #f9f9f9;
            border-radius: 5px;
        }
        .error-message {
            color: #dc3545;
            padding: 15px;
            background-color: #f8d7da;
            border-radius: 5px;
            margin-bottom: 20px;
            display: none;
        }
        .category-badge {
            background-color: #6c757d;
            color: white;
            padding: 5px 10px;
            border-radius: 20px;
            font-size: 14px;
            margin-bottom: 15px;
            display: inline-block;
        }
    </style>
</head>
<body>
    <div class="container recipe-container">
        <div class="text-center mb-4">
            <h1 class="mb-3">今日食谱</h1>
            <p class="text-muted">来自 HowToCook 项目的随机美食推荐</p>
            <button id="generateBtn" class="btn btn-primary mb-4">
                <i class="bi bi-shuffle me-2"></i>随机生成今日食谱
            </button>
        </div>

        <div class="error-message" id="errorMessage">
            <strong>出错了！</strong> <span id="errorText"></span>
            <div class="mt-2">
                <button class="btn btn-sm btn-danger" onclick="getRandomRecipe()">重试</button>
            </div>
        </div>

        <div id="recipeContent">
            <div class="loading" id="loadingIndicator">
                <div class="spinner-border text-primary" role="status">
                    <span class="visually-hidden">加载中...</span>
                </div>
            </div>
            <div id="recipeDisplay" style="display: none;">
                <div class="text-center mb-4">
                    <h2 id="recipeName" class="mb-3"></h2>
                    <div id="recipeCategory" class="mb-2"></div>
                    <img id="recipeImage" src="" alt="食谱图片" class="recipe-image">
                </div>
                <div class="ingredients mb-4">
                    <h3>食材</h3>
                    <ul id="ingredientsList" class="list-group list-group-flush"></ul>
                </div>
                <div class="steps">
                    <h3>做法</h3>
                    <div id="stepsList"></div>
                </div>
            </div>
        </div>

        <!-- 返回主页链接 -->
        <div class="text-center mt-4">
            <a href="index.html" class="btn btn-outline-secondary">返回主页</a>
        </div>
    </div>

    <script>
        // GitHub API路径
        const apiBase = 'https://api.github.com/repos/Anduin2017/HowToCook/contents/';
        const rawBase = 'https://raw.githubusercontent.com/Anduin2017/HowToCook/main/';
        
        // 食谱分类映射
        const categoryMapping = {
            'appetizer': '开胃菜',
            'aquatic': '水产',
            'breakfast': '早餐',
            'drink': '饮品',
            'dessert': '甜点',
            'meat_dish': '荤菜',
            'condiment': '调味料',
            'pasta': '意面/米线',
            'principal': '主食',
            'salad': '沙拉',
            'soup': '汤',
            'semi_finished': '半成品',
            'staple': '主食',
            'vegetable_dish': '素菜'
        };

        // 辅助函数：处理API错误
        function handleError(message) {
            document.getElementById('loadingIndicator').style.display = 'none';
            document.getElementById('errorText').textContent = message;
            document.getElementById('errorMessage').style.display = 'block';
            console.error(message);
        }
        
        // 辅助函数：重置UI状态
        function resetUI() {
            document.getElementById('errorMessage').style.display = 'none';
            document.getElementById('recipeDisplay').style.display = 'none';
            document.getElementById('loadingIndicator').style.display = 'flex';
        }

        // 获取目录内容
        async function fetchDirectory(path) {
            try {
                const response = await fetch(apiBase + path);
                
                if (!response.ok) {
                    if (response.status === 403) {
                        throw new Error('GitHub API速率限制，请稍后再试');
                    } else {
                        throw new Error('无法获取目录内容，状态码: ' + response.status);
                    }
                }
                
                return await response.json();
            } catch (error) {
                throw new Error('获取目录失败: ' + error.message);
            }
        }
        
        // 获取文件内容（从raw.githubusercontent.com获取内容）
        async function fetchFileContent(path) {
            try {
                const response = await fetch(rawBase + path);
                
                if (!response.ok) {
                    throw new Error('无法获取文件内容，状态码: ' + response.status);
                }
                
                return await response.text();
            } catch (error) {
                throw new Error('获取文件内容失败: ' + error.message);
            }
        }
        
        // 解析Markdown内容
        function parseRecipe(content, category, fileName) {
            const recipe = {
                name: fileName.replace('.md', ''),
                category: category,
                ingredients: [],
                steps: [],
                image: null
            };
            
            // 解析菜名（第一个一级标题）
            const titleMatch = content.match(/# (.+)/);
            if (titleMatch) {
                recipe.name = titleMatch[1];
            }
            
            // 查找图片
            const imageMatch = content.match(/!\[.+?\]\((.+?)\)/);
            if (imageMatch) {
                let imagePath = imageMatch[1];
                // 确保图片链接是绝对URL
                if (imagePath.startsWith('./')) {
                    imagePath = imagePath.substring(2); // 移除开头的 ./
                }
                recipe.image = rawBase + imagePath;
            }
            
            // 解析食材（二级标题后的列表项）
            // 查找"原料"或"配料"部分
            let ingredientsMatch = content.match(/## 原料[\s\S]+?(?=##|$)/);
            if (!ingredientsMatch) {
                ingredientsMatch = content.match(/## 配料[\s\S]+?(?=##|$)/);
            }
            if (ingredientsMatch) {
                const ingredientsSection = ingredientsMatch[0];
                const ingredientsList = ingredientsSection.match(/- (.+)/g);
                if (ingredientsList) {
                    recipe.ingredients = ingredientsList.map(item => item.replace('- ', ''));
                }
            }
            
            // 解析步骤（查找"步骤"或"做法"部分）
            let stepsMatch = content.match(/## 步骤[\s\S]+?(?=##|$)/);
            if (!stepsMatch) {
                stepsMatch = content.match(/## 做法[\s\S]+?(?=##|$)/);
            }
            if (stepsMatch) {
                const stepsSection = stepsMatch[0];
                // 匹配 1. xxx 格式或者 - xxx 格式的步骤
                const numberSteps = stepsSection.match(/\d+\. (.+?)(?=\d+\.|$)/gs);
                const bulletSteps = stepsSection.match(/- (.+)/g);
                
                if (numberSteps) {
                    recipe.steps = numberSteps.map(step => step.trim());
                } else if (bulletSteps) {
                    recipe.steps = bulletSteps.map(step => step.replace('- ', ''));
                }
            }
            
            return recipe;
        }
        
        // 随机选择一个食谱
        async function getRandomRecipe() {
            resetUI();
            
            try {
                // 获取菜谱分类目录
                const dishesPath = 'dishes';
                const categories = await fetchDirectory(dishesPath);
                const validCategories = categories.filter(item => item.type === 'dir');
                
                if (validCategories.length === 0) {
                    throw new Error('未找到任何食谱分类');
                }
                
                // 随机选择一个分类
                const randomCategory = validCategories[Math.floor(Math.random() * validCategories.length)];
                const categoryName = randomCategory.name;
                
                // 获取该分类下的所有菜谱
                const recipes = await fetchDirectory(randomCategory.path);
                const mdRecipes = recipes.filter(item => item.name.endsWith('.md'));
                
                if (mdRecipes.length === 0) {
                    throw new Error(`在 ${categoryName} 分类中未找到任何食谱`);
                }
                
                // 随机选择一个菜谱
                const randomRecipe = mdRecipes[Math.floor(Math.random() * mdRecipes.length)];
                
                // 获取菜谱内容
                const content = await fetchFileContent(`${randomCategory.path}/${randomRecipe.name}`);
                const recipeData = parseRecipe(content, categoryName, randomRecipe.name);
                
                displayRecipe(recipeData);
            } catch (error) {
                handleError(error.message);
            }
        }
        
        // 显示菜谱
        function displayRecipe(recipe) {
            // 显示菜名
            document.getElementById('recipeName').textContent = recipe.name;
            
            // 显示分类
            const categoryElem = document.getElementById('recipeCategory');
            categoryElem.innerHTML = '';
            if (recipe.category && categoryMapping[recipe.category]) {
                const badge = document.createElement('span');
                badge.className = 'category-badge';
                badge.textContent = categoryMapping[recipe.category] || recipe.category;
                categoryElem.appendChild(badge);
            }
            
            // 显示图片
            const imageElem = document.getElementById('recipeImage');
            if (recipe.image) {
                imageElem.src = recipe.image;
                imageElem.style.display = 'block';
            } else {
                imageElem.style.display = 'none';
            }
            
            // 显示食材
            const ingredientsList = document.getElementById('ingredientsList');
            ingredientsList.innerHTML = '';
            
            if (recipe.ingredients.length > 0) {
                recipe.ingredients.forEach(ingredient => {
                    const li = document.createElement('li');
                    li.className = 'list-group-item';
                    li.textContent = ingredient;
                    ingredientsList.appendChild(li);
                });
            } else {
                const li = document.createElement('li');
                li.className = 'list-group-item text-muted';
                li.textContent = '未找到食材信息';
                ingredientsList.appendChild(li);
            }
            
            // 显示步骤
            const stepsList = document.getElementById('stepsList');
            stepsList.innerHTML = '';
            
            if (recipe.steps.length > 0) {
                recipe.steps.forEach((step, index) => {
                    const div = document.createElement('div');
                    div.className = 'step';
                    
                    // 如果步骤本身已经包含数字序号，则直接显示
                    if (step.match(/^\d+\./)) {
                        div.innerHTML = step;
                    } else {
                        div.innerHTML = `<strong>${index + 1}.</strong> ${step}`;
                    }
                    
                    stepsList.appendChild(div);
                });
            } else {
                const div = document.createElement('div');
                div.className = 'step text-muted';
                div.textContent = '未找到步骤信息';
                stepsList.appendChild(div);
            }
            
            // 隐藏加载指示器，显示菜谱信息
            document.getElementById('loadingIndicator').style.display = 'none';
            document.getElementById('recipeDisplay').style.display = 'block';
        }
        
        // 添加按钮事件监听器
        document.getElementById('generateBtn').addEventListener('click', getRandomRecipe);
        
        // 页面加载时自动生成一个食谱
        window.addEventListener('load', getRandomRecipe);
    </script>
</body>
</html> 